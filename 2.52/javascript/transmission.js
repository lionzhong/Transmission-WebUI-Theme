function Transmission(){this.initialize()}Transmission.prototype={initialize:function(){var e;this.remote=new TransmissionRemote(this),this.inspector=new Inspector(this,this.remote),this.prefsDialog=new PrefsDialog(this.remote),$(this.prefsDialog).bind("closed",$.proxy(this.onPrefsDialogClosed,this)),this.isMenuEnabled=!isMobileDevice,this.filterText="",this._torrents={},this._rows=[],this.dirtyTorrents={},this.uriCache={},Prefs.getClutchPrefs(this),$(".numberinput").forceNumeric(),$("#toolbar-pause").click($.proxy(this.stopSelectedClicked,this)),$("#toolbar-start").click($.proxy(this.startSelectedClicked,this)),$("#toolbar-pause-all").click($.proxy(this.stopAllClicked,this)),$("#toolbar-start-all").click($.proxy(this.startAllClicked,this)),$("#toolbar-remove").click($.proxy(this.removeClicked,this)),$("#toolbar-open").click($.proxy(this.openTorrentClicked,this)),$("#prefs-button").click($.proxy(this.togglePrefsDialogClicked,this)),$("#upload_confirm_button").click($.proxy(this.confirmUploadClicked,this)),$("#upload_cancel_button").click($.proxy(this.hideUploadDialog,this)),$("#turtle-button").click($.proxy(this.toggleTurtleClicked,this)),$("#compact-button").click($.proxy(this.toggleCompactClicked,this)),jQuery.event.props.push("dataTransfer"),$("#torrent_upload_form").submit(function(){return $("#upload_confirm_button").click(),!1}),$("#toolbar-inspector").click($.proxy(this.toggleInspector,this)),e=$("#filter-mode"),e.val(this[Prefs._FilterMode]),e.change($.proxy(this.onFilterModeClicked,this)),$("#filter-tracker").change($.proxy(this.onFilterTrackerClicked,this)),isMobileDevice||($(document).bind("keydown",$.proxy(this.keyDown,this)),$(document).bind("keyup",$.proxy(this.keyUp,this)),$("#torrent_container").click($.proxy(this.deselectAll,this)),$("#torrent_container").bind("dragover",$.proxy(this.dragenter,this)),$("#torrent_container").bind("dragenter",$.proxy(this.dragenter,this)),$("#torrent_container").bind("drop",$.proxy(this.drop,this)),$("#inspector_link").click($.proxy(this.toggleInspector,this)),this.setupSearchBox(),this.createContextMenu()),this.isMenuEnabled&&this.createSettingsMenu(),e={},e.torrent_list=$("#torrent_list")[0],e.toolbar_buttons=$("#toolbar ul li"),e.toolbar_pause_button=$("#toolbar-pause")[0],e.toolbar_start_button=$("#toolbar-start")[0],e.toolbar_remove_button=$("#toolbar-remove")[0],this.elements=e,this.initializeSettings();var t=!1;this.loadDaemonPrefs(t),this.loadDaemonStats(t),this.initializeTorrents(),this.refreshTorrents(),this.togglePeriodicSessionRefresh(!0),this.updateButtonsSoon()},loadDaemonPrefs:function(e){this.remote.loadDaemonPrefs(function(e){var t=e.arguments;Prefs.getClutchPrefs(t),this.updateGuiFromSession(t),this.sessionProperties=t},this,e)},loadImages:function(){for(var e,t=0;e=arguments[t];++t)jQuery("<img>").attr("src",e)},initializeSettings:function(){Prefs.getClutchPrefs(this),this.isMenuEnabled&&($("#sort_by_"+this[Prefs._SortMethod]).selectMenuItem(),this[Prefs._SortDirection]===Prefs._SortDescending&&$("#reverse_sort_order").selectMenuItem()),this.initCompactMode()},setupSearchBox:function(){var e=this,t=$("#torrent_search");t.bind("keyup click",function(){e.setFilterText(this.value)}),$.browser.safari||(t.addClass("blur"),t[0].value="Filter",t.bind("blur",function(){""===this.value&&($(this).addClass("blur"),this.value="Filter",e.setFilterText(null))}).bind("focus",function(){$(this).is(".blur")&&(this.value="",$(this).removeClass("blur"))}))},createContextMenu:function(){var e=this,t={context_pause_selected:function(){e.stopSelectedTorrents()},context_resume_selected:function(){e.startSelectedTorrents(!1)},context_resume_now_selected:function(){e.startSelectedTorrents(!0)},context_remove:function(){e.removeSelectedTorrents()},context_removedata:function(){e.removeSelectedTorrentsAndData()},context_verify:function(){e.verifySelectedTorrents()},context_reannounce:function(){e.reannounceSelectedTorrents()},context_move_top:function(){e.moveTop()},context_move_up:function(){e.moveUp()},context_move_down:function(){e.moveDown()},context_move_bottom:function(){e.moveBottom()}};$("ul#torrent_list").contextMenu("torrent_context_menu",{bindings:t,menuStyle:{width:"310px",backgroundColor:"#fff",border:"none",padding:"5px 0",textAlign:"left"},itemStyle:{backgroundColor:"transparent",margin:"0",padding:"3px 10px 3px 20px",color:"#000",cursor:"default",border:"none"},itemHoverStyle:{backgroundColor:"#4dd097",color:"#fff",border:"none"},shadow:!1,boundingElement:$("div#torrent_container"),boundingRightPad:20,boundingBottomPad:5,onContextMenu:function(t){var r=$(t.target).closest(".torrent")[0],s=$("#torrent_list > li").index(r);return s===-1||e._rows[s].isSelected()||e.setSelectedRow(e._rows[s]),!0}})},createSettingsMenu:function(){$("#settings_menu").transMenu({selected_char:"&#x2714;",direction:"up",onClick:$.proxy(this.onMenuClicked,this)}),$("#unlimited_download_rate").selectMenuItem(),$("#unlimited_upload_rate").selectMenuItem()},getAllTorrents:function(){var e=[];for(var t in this._torrents)e.push(this._torrents[t]);return e},getTorrentIds:function(e){return $.map(e.slice(0),function(e){return e.getId()})},scrollToRow:function(e){if(!isMobileDevice){var t=$("#torrent_container"),r=t.scrollTop(),s=t.innerHeight(),o=e.getElement().offsetTop,i=$(e.getElement()).outerHeight();o<r?t.scrollTop(o):s+r<o+i&&t.scrollTop(o+i-s)}},seedRatioLimit:function(){var e=this.sessionProperties;return e&&e.seedRatioLimited?e.seedRatioLimit:-1},setPref:function(e,t){this[e]=t,Prefs.setValue(e,t)},getSelectedRows:function(){return $.grep(this._rows,function(e){return e.isSelected()})},getSelectedTorrents:function(){return $.map(this.getSelectedRows(),function(e){return e.getTorrent()})},getSelectedTorrentIds:function(){return this.getTorrentIds(this.getSelectedTorrents())},setSelectedRow:function(e){$(this.elements.torrent_list).children(".selected").removeClass("selected"),this.selectRow(e)},selectRow:function(e){$(e.getElement()).addClass("selected"),this.callSelectionChangedSoon()},deselectRow:function(e){$(e.getElement()).removeClass("selected"),this.callSelectionChangedSoon()},selectAll:function(){$(this.elements.torrent_list).children().addClass("selected"),this.callSelectionChangedSoon()},deselectAll:function(){$(this.elements.torrent_list).children(".selected").removeClass("selected"),this.callSelectionChangedSoon(),delete this._last_torrent_clicked},indexOfLastTorrent:function(){for(var e,t=0;e=this._rows[t];++t)if(e.getTorrentId()===this._last_torrent_clicked)return t;return-1},selectRange:function(e){var t=this.indexOfLastTorrent();if(t===-1)this.selectRow(e);else for(var r=this._rows.indexOf(e),s=Math.min(t,r),o=Math.max(t,r),i=s;i<=o;++i)this.selectRow(this._rows[i]);this.callSelectionChangedSoon()},selectionChanged:function(){this.updateButtonStates(),this.inspector.setTorrents(this.inspectorIsVisible()?this.getSelectedTorrents():[]),clearTimeout(this.selectionChangedTimer),delete this.selectionChangedTimer},callSelectionChangedSoon:function(){if(!this.selectionChangedTimer){var e=$.proxy(this.selectionChanged,this),t=200;this.selectionChangedTimer=setTimeout(e,t)}},keyDown:function(e){var t=!1,r=this._rows,s=38===e.keyCode,o=40===e.keyCode,i=16===e.keyCode;if((s||o)&&r.length){var n,a=this.indexOfLastTorrent(),l=a,d=this._shift_index,c=0,h=r.length-1;o&&l+1<=h?++l:s&&l-1>=c&&--l;var n=r[l];d>=0?d<=a&&a<l||d>=a&&a>l?this.selectRow(n):(d>=a&&l>a||d<=a&&a>l)&&this.deselectRow(r[a]):e.shiftKey?this.selectRange(n):this.setSelectedRow(n),this._last_torrent_clicked=n.getTorrentId(),this.scrollToRow(n),t=!0}else i&&(this._shift_index=this.indexOfLastTorrent());return!t},keyUp:function(e){16===e.keyCode&&delete this._shift_index},isButtonEnabled:function(e){var t=(e.target||e.srcElement).parentNode;return"disabled"!==t.className&&"disabled"!==t.parentNode.className},stopSelectedClicked:function(e){this.isButtonEnabled(e)&&(this.stopSelectedTorrents(),this.hideMobileAddressbar())},startSelectedClicked:function(e){this.isButtonEnabled(e)&&(this.startSelectedTorrents(!1),this.hideMobileAddressbar())},stopAllClicked:function(e){this.isButtonEnabled(e)&&(this.stopAllTorrents(),this.hideMobileAddressbar())},startAllClicked:function(e){this.isButtonEnabled(e)&&(this.startAllTorrents(!1),this.hideMobileAddressbar())},openTorrentClicked:function(e){this.isButtonEnabled(e)&&($("body").addClass("open_showing"),this.uploadTorrentFile(),this.updateButtonStates())},dragenter:function(e){if(e.dataTransfer&&e.dataTransfer.types){for(var t=["text/uri-list","text/plain"],r=0;r<t.length;++r)if(e.dataTransfer.types.contains(t[r]))return e.stopPropagation(),e.preventDefault(),e.dropEffect="copy",!1}else e.dataTransfer&&(e.dataTransfer.dropEffect="none");return!0},drop:function(e){var t,r,s=null,o=["text/uri-list","text/plain"];if(paused=this.shouldAddedTorrentsStart(),!e.dataTransfer||!e.dataTransfer.types)return!0;for(t=0;!s&&t<o.length;++t)e.dataTransfer.types.contains(o[t])&&(s=e.dataTransfer.getData(o[t]).split("\n"));for(t=0;r=s[t];++t)/^#/.test(r)||/^[a-z-]+:/i.test(r)&&this.remote.addTorrentByUrl(r,paused);return e.preventDefault(),!1},hideUploadDialog:function(){$("body.open_showing").removeClass("open_showing"),$("#upload_container").hide(),this.updateButtonStates()},confirmUploadClicked:function(){this.uploadTorrentFile(!0),this.hideUploadDialog()},removeClicked:function(e){this.isButtonEnabled(e)&&(this.removeSelectedTorrents(),this.hideMobileAddressbar())},togglePeriodicSessionRefresh:function(e){if(clearInterval(this.sessionInterval),delete this.sessionInterval,e){var t=$.proxy(this.loadDaemonPrefs,this),r=8e3;this.sessionInterval=setInterval(t,r)}},toggleTurtleClicked:function(){var e={};e[RPC._TurtleState]=!$("#turtle-button").hasClass("selected"),this.remote.savePrefs(e)},onPrefsDialogClosed:function(){$("#prefs-button").removeClass("selected")},togglePrefsDialogClicked:function(e){var t=$("#prefs-button");t.hasClass("selected")?this.prefsDialog.close():(t.addClass("selected"),this.prefsDialog.show())},setFilterText:function(e){this.filterText=e?e.trim():null,this.refilter(!0)},setSortMethod:function(e){this.setPref(Prefs._SortMethod,e),this.refilter(!0)},setSortDirection:function(e){this.setPref(Prefs._SortDirection,e),this.refilter(!0)},onMenuClicked:function(e){var t,r,s=e.target.id,o=this.remote,i=$(e.target);if(i.hasClass("sort-mode"))i.parent().find(".sort-mode").each(function(){i.parent().deselectMenuItem()}),i.selectMenuItem(),this.setSortMethod(s.replace(/sort_by_/,""));else if(i.hasClass("upload-speed"))t={},t[RPC._UpSpeedLimit]=parseInt(e.target.innerHTML),t[RPC._UpSpeedLimited]=!0,o.savePrefs(t);else if(i.hasClass("download-speed"))t={},t[RPC._DownSpeedLimit]=parseInt(e.target.innerHTML),t[RPC._DownSpeedLimited]=!0,o.savePrefs(t);else switch(s){case"statistics":this.showStatsDialog();break;case"about-button":t="Transmission "+this.serverVersion,$("#about-dialog #about-title").html(t),$("#about-dialog").dialog({title:"关于Transmission",show:"fade",hide:"fade"});break;case"homepage":window.open("http://www.transmissionbt.com/");break;case"tipjar":window.open("http://www.transmissionbt.com/donate.php");break;case"unlimited_download_rate":t={},t[RPC._DownSpeedLimited]=!1,o.savePrefs(t);break;case"limited_download_rate":t={},t[RPC._DownSpeedLimited]=!0,o.savePrefs(t);break;case"unlimited_upload_rate":t={},t[RPC._UpSpeedLimited]=!1,o.savePrefs(t);break;case"limited_upload_rate":t={},t[RPC._UpSpeedLimited]=!0,o.savePrefs(t);break;case"reverse_sort_order":i.menuItemIsSelected()?(r=Prefs._SortAscending,i.deselectMenuItem()):(r=Prefs._SortDescending,i.selectMenuItem()),this.setSortDirection(r);break;default:console.log("unhandled: "+s)}$("#settings_menu").trigger("closemenu"),e.stopImmediatePropagation()},onTorrentChanged:function(e,t){this.dirtyTorrents[t.getId()]=!0,this.refilterSoon(),this.updateButtonsSoon()},updateFromTorrentGet:function(e,t){var r,s,o,i,n,a,l,d=[];for(r=0;s=e[r];++r)i=s.id,(o=this._torrents[i])?(n=o.needsMetaData(),o.refresh(s),n&&!o.needsMetaData()&&d.push(i)):(o=this._torrents[i]=new Torrent(s),this.dirtyTorrents[i]=!0,a=$.proxy(this.onTorrentChanged,this),$(o).bind("dataChanged",a),"name"in o.fields&&"status"in o.fields||d.push(i));d.length&&(l=["id"].concat(Torrent.Fields.Metadata,Torrent.Fields.Stats),this.updateTorrents(d,l),this.refilterSoon()),t&&(this.deleteTorrents(t),this.refilterSoon())},updateTorrents:function(e,t){this.remote.updateTorrents(e,t,this.updateFromTorrentGet,this)},refreshTorrents:function(){var e=$.proxy(this.refreshTorrents,this),t=1e3*this[Prefs._RefreshRate],r=["id"].concat(Torrent.Fields.Stats);this.updateTorrents("recently-active",r),clearTimeout(this.refreshTorrentsTimeout),this.refreshTorrentsTimeout=setTimeout(e,t)},initializeTorrents:function(){var e=["id"].concat(Torrent.Fields.Metadata,Torrent.Fields.Stats);this.updateTorrents(null,e)},onRowClicked:function(e){var t=e.metaKey||e.ctrlKey,r=e.currentTarget.row;return"torrent_resume"===e.target.className?void this.startTorrent(r.getTorrent()):"torrent_pause"===e.target.className?void this.stopTorrent(r.getTorrent()):(e.stopPropagation(),$("#jqContextMenu").hide(),isMobileDevice?(r.isSelected()&&this.setInspectorVisible(!0),this.setSelectedRow(r)):e.shiftKey?(this.selectRange(r),window.focus()):!r.isSelected()&&t?this.selectRow(r):r.isSelected()?r.isSelected()&&t?this.deselectRow(r):r.isSelected()&&this.setSelectedRow(r):this.setSelectedRow(r),void(this._last_torrent_clicked=r.getTorrentId()))},deleteTorrents:function(e){var t,r;if(e&&e.length){for(t=0;r=e[t];++t)this.dirtyTorrents[r]=!0,delete this._torrents[r];this.refilter()}},shouldAddedTorrentsStart:function(){return this.prefsDialog.shouldAddedTorrentsStart()},uploadTorrentFile:function(e){if(e){var t={},r=this.remote,s=!$("#torrent_auto_start").is(":checked");""!=$("#torrent_upload_url").val()?r.addTorrentByUrl($("#torrent_upload_url").val(),{paused:s}):(t.url="../upload?paused="+s,t.type="POST",t.data={"X-Transmission-Session-Id":r._token},t.dataType="xml",t.iframe=!0,$("#torrent_upload_form").ajaxSubmit(t))}else $("input#torrent_upload_file").attr("value",""),$("input#torrent_upload_url").attr("value",""),$("input#torrent_auto_start").attr("checked",this.shouldAddedTorrentsStart()),$("#upload_container").show(),$("#torrent_upload_url").focus()},removeSelectedTorrents:function(){var e=this.getSelectedTorrents();e.length&&this.promptToRemoveTorrents(e)},removeSelectedTorrentsAndData:function(){var e=this.getSelectedTorrents();e.length&&this.promptToRemoveTorrentsAndData(e)},promptToRemoveTorrents:function(e){if(1===e.length){var t=e[0],r="移除 "+t.getName()+"?",s="一旦移除，继续下载需要提供种子文件，你确定要移除吗？";dialog.confirm(r,s,"移除","transmission.removeTorrents",e)}else{var r="移除选择的 "+e.length+" 个传输任务?",s="一旦移除它们, 继续下载需要提供种子文件，你确定要移除它们吗？";dialog.confirm(r,s,"移除","transmission.removeTorrents",e)}},promptToRemoveTorrentsAndData:function(e){if(1===e.length){var t=e[0],r="移除 "+t.getName()+" 并删除数据?",s="所有属于此种子的数据将会被删除，你确定移除吗？";dialog.confirm(r,s,"移除","transmission.removeTorrentsAndData",e)}else{var r="移除 "+e.length+" transfers and delete data?",s="所有属于这些种子的数据将会被删除，你确定移除它们吗？";dialog.confirm(r,s,"移除","transmission.removeTorrentsAndData",e)}},removeTorrents:function(e){var t=this.getTorrentIds(e);this.remote.removeTorrents(t,this.refreshTorrents,this)},removeTorrentsAndData:function(e){this.remote.removeTorrentsAndData(e)},verifySelectedTorrents:function(){this.verifyTorrents(this.getSelectedTorrents())},reannounceSelectedTorrents:function(){this.reannounceTorrents(this.getSelectedTorrents())},startAllTorrents:function(e){this.startTorrents(this.getAllTorrents(),e)},startSelectedTorrents:function(e){this.startTorrents(this.getSelectedTorrents(),e)},startTorrent:function(e){this.startTorrents([e],!1)},startTorrents:function(e,t){this.remote.startTorrents(this.getTorrentIds(e),t,this.refreshTorrents,this)},verifyTorrent:function(e){this.verifyTorrents([e])},verifyTorrents:function(e){this.remote.verifyTorrents(this.getTorrentIds(e),this.refreshTorrents,this)},reannounceTorrent:function(e){this.reannounceTorrents([e])},reannounceTorrents:function(e){this.remote.reannounceTorrents(this.getTorrentIds(e),this.refreshTorrents,this)},stopAllTorrents:function(){this.stopTorrents(this.getAllTorrents())},stopSelectedTorrents:function(){this.stopTorrents(this.getSelectedTorrents())},stopTorrent:function(e){this.stopTorrents([e])},stopTorrents:function(e){this.remote.stopTorrents(this.getTorrentIds(e),this.refreshTorrents,this)},changeFileCommand:function(e,t,r){this.remote.changeFileCommand(e,t,r)},hideMobileAddressbar:function(e){if(isMobileDevice&&!scroll_timeout){var t=$.proxy(this.doToolbarHide,this),r=1e3*e||150;scroll_timeout=setTimeout(t,r)}},doToolbarHide:function(){window.scrollTo(0,1),scroll_timeout=null},moveTop:function(){this.remote.moveTorrentsToTop(this.getSelectedTorrentIds(),this.refreshTorrents,this)},moveUp:function(){this.remote.moveTorrentsUp(this.getSelectedTorrentIds(),this.refreshTorrents,this)},moveDown:function(){this.remote.moveTorrentsDown(this.getSelectedTorrentIds(),this.refreshTorrents,this)},moveBottom:function(){this.remote.moveTorrentsToBottom(this.getSelectedTorrentIds(),this.refreshTorrents,this)},updateGuiFromSession:function(e){var t,r,s,o,i,n=Transmission.fmt,a=$("#settings_menu");this.serverVersion=e.version,this.prefsDialog.set(e),RPC._TurtleState in e&&(o=e[RPC._TurtleState],s=$("#turtle-button"),i=["点击",o?"关闭":"开启","临时限速(","上传：",n.speed(e[RPC._TurtleUpSpeedLimit])," 下载：",n.speed(e[RPC._TurtleDownSpeedLimit]),")"].join(""),s.toggleClass("selected",o),s.attr("title",i)),this.isMenuEnabled&&RPC._DownSpeedLimited in e&&RPC._DownSpeedLimit in e&&(t=e[RPC._DownSpeedLimit],r=e[RPC._DownSpeedLimited],s=a.find("#limited_download_rate"),s.html("Limit ("+n.speed(t)+")"),r||(s=a.find("#unlimited_download_rate")),s.deselectMenuSiblings().selectMenuItem()),this.isMenuEnabled&&RPC._UpSpeedLimited in e&&RPC._UpSpeedLimit in e&&(t=e[RPC._UpSpeedLimit],r=e[RPC._UpSpeedLimited],s=a.find("#limited_upload_rate"),s.html("Limit ("+n.speed(t)+")"),r||(s=a.find("#unlimited_upload_rate")),s.deselectMenuSiblings().selectMenuItem())},updateStatusbar:function(){var e,t,r=0,s=0,o=Transmission.fmt,i=this.getAllTorrents();for(e=0;t=i[e];++e)r+=t.getUploadSpeed(),s+=t.getDownloadSpeed();$("#speed-up-container").toggleClass("active",r>0),$("#speed-up-label").text(o.speedBps(r)),$("#speed-dn-container").toggleClass("active",s>0),$("#speed-dn-label").text(o.speedBps(s)),$("#filter-count").text(o.plural(this._rows.length,"个传输任务"))},setEnabled:function(e,t){$(e).toggleClass("disabled",!t)},updateFilterSelect:function(){var e,t,r,s,o,i=($("#filter-tracker"),this.getTrackers());t=[];for(r in i)t.push(r);for(t.sort(),s=this.filterTracker?'<option value="all">所有Tracker</option>':'<option value="all" selected="selected">所有Tracker</option>',e=0;r=t[e];++e)o=i[r],s+='<option value="'+o.domain+'"',i[r].domain===this.filterTracker&&(s+=' selected="selected"'),s+=">"+r+"</option>";this.filterTrackersStr&&this.filterTrackersStr===s||(this.filterTrackersStr=s,$("#filter-tracker").html(s))},updateButtonsSoon:function(){if(!this.buttonRefreshTimer){var e=$.proxy(this.updateButtonStates,this),t=100;this.buttonRefreshTimer=setTimeout(e,t)}},updateButtonStates:function(){var e=this.elements,t=!1,r=!1,s=!1,o=!1,i=!1;clearTimeout(this.buttonRefreshTimer),delete this.buttonRefreshTimer;for(var n,a=0;n=this._rows[a];++a){var l=n.getTorrent().isStopped(),d=n.isSelected();l||(t=!0),l&&(r=!0),d&&(s=!0),d&&!l&&(o=!0),d&&l&&(i=!0)}this.setEnabled(e.toolbar_pause_button,o),this.setEnabled(e.toolbar_start_button,i),this.setEnabled(e.toolbar_remove_button,s)},inspectorIsVisible:function(){return $("#torrent_inspector").is(":visible")},toggleInspector:function(){this.setInspectorVisible(!this.inspectorIsVisible())},setInspectorVisible:function(e){if(e&&this.inspector.setTorrents(this.getSelectedTorrents()),$("#torrent_inspector").toggle(e),$("#toolbar-inspector").toggleClass("selected",e),this.hideMobileAddressbar(),isMobileDevice)$("body").toggleClass("inspector_showing",e);else{var t=e?$("#torrent_inspector").outerWidth()+1+"px":"0px";$("#torrent_container")[0].style.right=t}},refilterSoon:function(){if(!this.refilterTimer){var e=this,t=function(){e.refilter(!1)},r=100;this.refilterTimer=setTimeout(t,r)}},sortRows:function(e){var t,r,s,o={},i=[];for(t=0;s=e[t];++t)r=s.getTorrent(),i.push(r),o[r.getId()]=s;for(Torrent.sortTorrents(i,this[Prefs._SortMethod],this[Prefs._SortDirection]),t=0;r=i[t];++t)e[t]=o[r.getId()]},refilter:function(e){var t,r,s,o,i,n,a,l,d,c,h=this[Prefs._SortMethod],u=this[Prefs._SortDirection],f=this[Prefs._FilterMode],p=this.filterText,m=this.filterTracker,T=this.torrentRenderer,g=this.elements.torrent_list,_=$(g).children(".selected").length;if(this.updateFilterSelect(),clearTimeout(this.refilterTimer),delete this.refilterTimer,e){$(g).empty(),this._rows=[];for(s in this._torrents)this.dirtyTorrents[s]=!0}for(l=[],d=[],t=0;i=this._rows[t];++t)i.getTorrentId()in this.dirtyTorrents?d.push(i):l.push(i);for(r=[],t=0;i=d[t];++t)r.push(i.getElement());for($(r).detach(),n=[],t=0;i=d[t];++t)s=i.getTorrentId(),o=this._torrents[s],o&&o.test(f,p,m)&&n.push(i),delete this.dirtyTorrents[s];d=n;for(s in this.dirtyTorrents)o=this._torrents[s],o&&o.test(f,p,m)&&(i=new TorrentRow(T,this,o),r=i.getElement(),r.row=i,d.push(i),$(r).click($.proxy(this.onRowClicked,this)),$(r).dblclick($.proxy(this.toggleInspector,this)));this.sortRows(d),a=[];var v=0,S=l.length,b=0,C=d.length;for(c=document.createDocumentFragment();v!=S||b!=C;){var w;if(v==S)w=!1;else if(b==C)w=!0;else{var k=Torrent.compareTorrents(l[v].getTorrent(),d[b].getTorrent(),h,u);w=k<0}w?a.push(l[v++]):(i=d[b++],r=i.getElement(),v!==S?g.insertBefore(r,l[v].getElement()):c.appendChild(r),a.push(i))}for(g.appendChild(c),this._rows=a,this.dirtyTorrents={},r=[],t=0;i=a[t];++t)r.push(i.getElement());$(r).filter(":odd").addClass("even"),$(r).filter(":even").removeClass("even"),this.updateStatusbar(),_!==$(g).children(".selected").length&&this.selectionChanged()},setFilterMode:function(e){this.setPref(Prefs._FilterMode,e),this.refilter(!0)},onFilterModeClicked:function(e){this.setFilterMode($("#filter-mode").val())},onFilterTrackerClicked:function(e){var t=$("#filter-tracker").val();this.setFilterTracker("all"===t?null:t)},setFilterTracker:function(e){var t=e?this.getReadableDomain(e):"all",r="#show-tracker-"+t;$(r).addClass("selected").siblings().removeClass("selected"),this.filterTracker=e,this.refilter(!0)},getDomainName:function(e){var t=e.indexOf(".");return t!==e.lastIndexOf(".")&&(e=e.slice(t+1)),e},getReadableDomain:function(e){e.length&&(e=e.charAt(0).toUpperCase()+e.slice(1));var t=e.indexOf(".");return t!==-1&&(e=e.slice(0,t)),e},getTrackers:function(){for(var e,t={},r=this.getAllTorrents(),s=0;e=r[s];++s){for(var o,i=[],n=e.getTrackers(),a=0;o=n[a];++a){var l,d=o.announce;d in this.uriCache?l=this.uriCache[d]:(l=this.uriCache[d]=parseUri(d),l.domain=this.getDomainName(l.host),l.name=this.getReadableDomain(l.domain)),l.name in t||(t[l.name]={uri:l,domain:l.domain,count:0}),i.indexOf(l.name)===-1&&i.push(l.name)}for(var c,a=0;c=i[a];++a)t[c].count++}return t},toggleCompactClicked:function(){this.setCompactMode(!this[Prefs._CompactDisplayState])},setCompactMode:function(e){var t=Prefs._CompactDisplayState,r=this[t];r!==e&&(this.setPref(t,e),this.onCompactModeChanged())},initCompactMode:function(){this.onCompactModeChanged()},onCompactModeChanged:function(){var e=this[Prefs._CompactDisplayState];$("#compact-button").toggleClass("selected",e),this.torrentRenderer=e?new TorrentRendererCompact:new TorrentRendererFull,this.refilter(!0)},togglePeriodicStatsRefresh:function(e){if(clearInterval(this.statsInterval),delete this.statsInterval,e){var t=$.proxy(this.loadDaemonStats,this),r=5e3;this.statsInterval=setInterval(t,r)}},loadDaemonStats:function(e){this.remote.loadDaemonStats(function(e){this.updateStats(e.arguments)},this,e)},updateStats:function(e){var t,r,s=Transmission.fmt;t=e["current-stats"],r=Math.ratio(t.uploadedBytes,t.downloadedBytes),$("#stats-session-uploaded").html(s.size(t.uploadedBytes)),$("#stats-session-downloaded").html(s.size(t.downloadedBytes)),$("#stats-session-ratio").html(s.ratioString(r)),$("#stats-session-duration").html(s.timeInterval(t.secondsActive)),t=e["cumulative-stats"],r=Math.ratio(t.uploadedBytes,t.downloadedBytes),$("#stats-total-count").html(t.sessionCount+" times"),$("#stats-total-uploaded").html(s.size(t.uploadedBytes)),$("#stats-total-downloaded").html(s.size(t.downloadedBytes)),$("#stats-total-ratio").html(s.ratioString(r)),$("#stats-total-duration").html(s.timeInterval(t.secondsActive))},showStatsDialog:function(){this.loadDaemonStats(),this.hideMobileAddressbar(),this.togglePeriodicStatsRefresh(!0),$("#stats-dialog").dialog({close:$.proxy(this.onStatsDialogClosed,this),show:"fade",hide:"fade",title:"统计"})},onStatsDialogClosed:function(){this.hideMobileAddressbar(),this.togglePeriodicStatsRefresh(!1)}};