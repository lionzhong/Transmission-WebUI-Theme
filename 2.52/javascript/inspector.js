function Inspector(e){var t={controller:null,elements:{},torrents:[]},n=function(e){var t,n;for(t=0;n=e[t];t++)if(!n.hasExtraInfo())return!0;return!1},r=function(){var e,r=$.map(t.torrents.slice(0),function(e){return e.getId()});r&&r.length&&(e=["id"].concat(Torrent.Fields.StatsExtra),n(t.torrents)&&$.merge(e,Torrent.Fields.InfoExtra),t.controller.updateTorrents(r,e))},i=function(e){var t=e.currentTarget;isMobileDevice&&e.stopPropagation(),$(t).addClass("selected").siblings().removeClass("selected"),$("#"+t.id.replace("tab","page")).show().siblings(".inspector-page").hide(),s()},s=function(){var e,n=t.elements,r=t.torrents;e=r&&r.length?1===r.length?r[0].getName():""+r.length+" Transfers Selected":"No Selection",setTextContent(n.name_lb,e||na),$(n.info_page).is(":visible")?l():$(n.peers_page).is(":visible")?u():$(n.trackers_page).is(":visible")?_():$(n.files_page).is(":visible")&&f()},l=function(){var e,n,r,i,s,l,a,o,c,d,g,p,f,u,h,m,v,_,b,T,C,$=t.torrents,S=t.elements,k=Transmission.fmt,w="无",x="已合并",y="未知",z=0,D=0,E=0,I=0,A=0,P=0,F=Date.now();if($.length<1)i=w;else{for(e=!1,n=!0,r=!0,s=$[0].getStatus(),a=0;o=$[a];++a)l=o.getStatus(),l!=s&&(e=!0),o.isStopped()||(n=r=!1),o.isFinished()||(r=!1);i=e?x:r?"已完成":n?"已暂停":$[0].getStateString()}if(setTextContent(S.state_lb,i),c=i,$.length<1)i=w;else{for(s=$[0].getStatus(),a=0;o=$[a];++a)o.needsMetaData()||(A+=o.getHaveUnchecked(),_=o.getHaveValid(),I+=_,o.getPieceSize()&&(P+=_/o.getPieceSize()),z+=o.getSizeWhenDone(),D+=o.getLeftUntilDone(),E+=o.getHave()+o.getDesiredAvailable());C=100*(z?(z-D)/z:1),i=k.percentString(C),i=A||D?A?k.size(I)+" / "+k.size(z)+" ("+i+"%), "+k.size(A)+" 未核实":k.size(I)+" / "+k.size(z)+" ("+i+"%)":k.size(I)+" (100%)"}if(setTextContent(S.have_lb,i),i=$.length<1?w:0==z?w:""+k.percentString(100*E/z)+"%",setTextContent(S.availability_lb,i),$.length<1)i=w;else{for(C=T=0,a=0;o=$[a];++a)C+=o.getDownloadedEver(),T+=o.getFailedEver();i=T?k.size(C)+" ("+k.size(T)+" 已丢弃)":k.size(C)}if(setTextContent(S.downloaded_lb,i),$.length<1)i=w;else{if(C=b=0,1==$.length)C=$[0].getDownloadedEver(),b=$[0].getUploadedEver(),0==C&&(C=$[0].getHaveValid());else for(a=0;o=$[a];++a)C+=o.getDownloadedEver(),b+=o.getUploadedEver();i=k.size(b)+" (分享率: "+k.ratioString(Math.ratio(b,C))+")"}if(setTextContent(S.uploaded_lb,i),$.length<1)i=w;else{for(n=!0,s=$[0].getStartDate(),a=0;o=$[a];++a)s!=o.getStartDate()&&(s=0),o.isStopped()||(n=!1);i=n?c:s?k.timeInterval(F/1e3-s):x}if(setTextContent(S.running_time_lb,i),i="",$.length<1)i=w;else for(s=$[0].getETA(),a=0;o=$[a];++a)if(s!=o.getETA()){i=x;break}if(i.length||(i=s<0?y:k.timeInterval(s)),setTextContent(S.remaining_time_lb,i),d=-1,$.length<1)i=w;else{for(s=$[0].getLastActivity(),a=0;o=$[a];++a)C=o.getLastActivity(),d<C&&(d=C);C=F/1e3-d,i=C<0?w:C<5?"现在":k.timeInterval(C)+" 以前"}if(setTextContent(S.last_activity_lb,i),$.length<1)i=w;else for(i=$[0].getErrorString(),a=0;o=$[a];++a)if(i!=o.getErrorString()){i=x;break}if(setTextContent(S.error_lb,parseStr(i)||w),$.length<1)i=w;else{for(g=0,p=0,f=$[0].getPieceSize(),a=0;o=$[a];++a)g+=o.getPieceCount(),p+=o.getTotalSize(),f!=o.getPieceSize()&&(f=0);i=p?f>0?k.size(p)+" ("+g.toStringWithCommas()+" 片 @ "+k.mem(f)+")":k.size(p)+" ("+g.toStringWithCommas()+" 片)":w}if(setTextContent(S.size_lb,i),$.length<1)i=w;else for(i=$[0].getHashString(),a=0;o=$[a];++a)if(i!=o.getHashString()){i=x;break}if(setTextContent(S.hash_lb,i),$.length<1)i=w;else for(s=$[0].getPrivateFlag(),i=s?"私有分享到这个 tracker -- 已禁用DHT 和 PEX":"发布种子",a=0;o=$[a];++a)if(s!=o.getPrivateFlag()){i=x;break}if(setTextContent(S.privacy_lb,i),$.length<1)i=w;else for(i=$[0].getComment(),a=0;o=$[a];++a)if(i!=o.getComment()){i=x;break}if(i||(i=w),setTextContent(S.comment_lb,i.replace(/(https?|ftp):\/\/([\w\-]+(\.[\w\-]+)*(\.[a-z]{2,4})?)(\d{1,5})?(\/([^<>\s]*))?/g,'<a target="_blank" href="$&">$&</a>')),$.length<1)i=w;else{for(h=!1,v=!1,u=$[0].getCreator(),m=$[0].getDateCreated(),a=0;o=$[a];++a)u!=o.getCreator()&&(h=!0),m!=o.getDateCreated()&&(v=!0);if(h&&v)i=x;else if(v&&u.length)i="创建者 "+u;else if(h&&m)i="创建日期 "+new Date(1e3*m).toDateString();else var H=new Date(1e3*m);var N=H.getFullYear()+"年"+H.getMonth()+"月"+H.getDay()+"日";i="在 "+N+"被"+u+"创建"}if(setTextContent(S.origin_lb,i),$.length<1)i=w;else for(i=$[0].getDownloadDir(),a=0;o=$[a];++a)if(i!=o.getDownloadDir()){i=x;break}setTextContent(S.foldername_lb,i)},a=function(e,n){var r=t.file_torrent.getId(),i=$.map(e.slice(0),function(e){return e.getIndex()});t.controller.changeFileCommand(r,i,n)},o=function(){a([],"files-wanted")},c=function(){a([],"files-unwanted")},d=function(e,t,n){a([t],n?"files-wanted":"files-unwanted")},g=function(e,t,n){var r;switch(n){case-1:r="priority-low";break;case 1:r="priority-high";break;default:r="priority-normal"}a([t],r)},p=function(){$(t.elements.file_list).empty(),delete t.file_torrent,delete t.file_rows},f=function(){var e,n,r,i,s,l=t.elements.file_list,a=t.torrents;if(1!==a.length)return void p();for(i=a[0],p(),t.file_torrent=i,n=i.getFileCount(),t.file_rows=[],s=document.createDocumentFragment(),e=0;e<n;++e)r=t.file_rows[e]=new FileRow(i,e),s.appendChild(r.getElement()),$(r).bind("wantedToggled",d),$(r).bind("priorityToggled",g);l.appendChild(s)},u=function(){var e,n,r,i,s,l,a=[],o=Transmission.fmt,c=t.elements.peers_list,d=t.torrents;for(n=0;r=d[n];++n)if(i=r.getPeers(),a.push('<div class="inspector_group">'),d.length>1&&a.push('<div class="inspector_torrent_label">',sanitizeText(r.getName()),"</div>"),i&&i.length){for(a.push('<table class="peer_list">','<tr class="inspector_peer_entry even">','<th class="encryptedCol"></th>','<th class="upCol">上传</th>','<th class="downCol">下载</th>','<th class="percentCol">%</th>','<th class="statusCol">状态</th>','<th class="addressCol">地址</th>','<th class="clientCol">客户端</th>',"</tr>"),e=0;s=i[e];++e)l=e%2?"odd":"even",a.push('<tr class="inspector_peer_entry ',l,'">',"<td>",s.isEncrypted?'<div class="encrypted-peer-cell" title="Encrypted Connection">':'<div class="unencrypted-peer-cell">',"</div>","</td>","<td>",s.rateToPeer?o.speedBps(s.rateToPeer):"","</td>","<td>",s.rateToClient?o.speedBps(s.rateToClient):"","</td>",'<td class="percentCol">',Math.floor(100*s.progress),"%","</td>","<td>",o.peerStatus(s.flagStr),"</td>","<td>",sanitizeText(s.address),"</td>",'<td class="clientCol">',sanitizeText(s.clientName),"</td>","</tr>");a.push("</table></div>")}else a.push("<br></div>");setInnerHTML(c,a.join(""))},h=function(e){var t,n="";switch(e.announceState){case Torrent._TrackerActive:n="正在播报";break;case Torrent._TrackerWaiting:t=e.nextAnnounceTime-(new Date).getTime()/1e3,t<0&&(t=0),n="下次播报时间："+Transmission.fmt.timeInterval(t);break;case Torrent._TrackerQueued:n="请求播报已排队";break;case Torrent._TrackerInactive:n=e.isBackup?"Tracker将作为备用":"没有播报计划";break;default:n="未知的播报状态: "+e.announceState}return n},m=function(e){var t,n="最后播报时间",r=["N/A"];return e.hasAnnounced&&(t=Transmission.fmt.timestamp(e.lastAnnounceTime),e.lastAnnounceSucceeded?r=[t," (已连接 ",Transmission.fmt.plural(e.lastAnnouncePeerCount,"peer"),")"]:(n="播报错误",r=[e.lastAnnounceResult?parseStr(e.lastAnnounceResult)+" - ":"",t])),{label:n,value:r.join("")}},v=function(e){var t,n="最后吸血时间",r="N/A";return e.hasScraped&&(t=Transmission.fmt.timestamp(e.lastScrapeTime),e.lastScrapeSucceeded?r=t:(n="吸血错误",r=(e.lastScrapeResult?e.lastScrapeResult+" - ":"")+t)),{label:n,value:r}},_=function(){var e,n,r,i,s,l,a,o,c,d,g,p="N/A",f=t.elements.trackers_list,u=t.torrents;for(a=[],e=0;l=u[e];++e){for(a.push('<div class="inspector_group">'),u.length>1&&a.push('<div class="inspector_torrent_label">',l.getName(),"</div>"),r=-1,s=l.getTrackers(),n=0;i=s[n];++n)r!=i.tier&&(r!==-1&&a.push("</ul></div>"),r=i.tier,a.push('<div class="inspector_group_label">',r," 层","</div>",'<ul class="tier_list">')),c=m(i),d=h(i),g=v(i),o=n%2?"odd":"even",a.push('<li class="inspector_tracker_entry ',o,'"><div class="tracker_host" title="',sanitizeText(i.announce),'">',sanitizeText(i.host),"</div>",'<div class="tracker_activity">',"<div>",c.label,": ",c.value,"</div>","<div>",d,"</div>","<div>",g.label,": ",g.value,"</div>",'</div><table class="tracker_stats">',"<tr><th>Seeders:</th><td>",i.seederCount>-1?i.seederCount:p,"</td></tr>","<tr><th>Leechers:</th><td>",i.leecherCount>-1?i.leecherCount:p,"</td></tr>","<tr><th>Downloads:</th><td>",i.downloadCount>-1?i.downloadCount:p,"</td></tr>","</table></li>");r!==-1&&a.push("</ul></div>"),a.push("</div>")}setInnerHTML(f,a.join(""))},b=function(e){t.controller=e,$(".inspector-tab").click(i),t.elements.info_page=$("#inspector-page-info")[0],t.elements.files_page=$("#inspector-page-files")[0],t.elements.peers_page=$("#inspector-page-peers")[0],t.elements.trackers_page=$("#inspector-page-trackers")[0],t.elements.file_list=$("#inspector_file_list")[0],t.elements.peers_list=$("#inspector_peers_list")[0],t.elements.trackers_list=$("#inspector_trackers_list")[0],t.elements.have_lb=$("#inspector-info-have")[0],t.elements.availability_lb=$("#inspector-info-availability")[0],t.elements.downloaded_lb=$("#inspector-info-downloaded")[0],t.elements.uploaded_lb=$("#inspector-info-uploaded")[0],t.elements.state_lb=$("#inspector-info-state")[0],t.elements.running_time_lb=$("#inspector-info-running-time")[0],t.elements.remaining_time_lb=$("#inspector-info-remaining-time")[0],t.elements.last_activity_lb=$("#inspector-info-last-activity")[0],t.elements.error_lb=$("#inspector-info-error")[0],t.elements.size_lb=$("#inspector-info-size")[0],t.elements.foldername_lb=$("#inspector-info-location")[0],t.elements.hash_lb=$("#inspector-info-hash")[0],t.elements.privacy_lb=$("#inspector-info-privacy")[0],t.elements.origin_lb=$("#inspector-info-origin")[0],t.elements.comment_lb=$("#inspector-info-comment")[0],t.elements.name_lb=$("#torrent_inspector_name")[0],$("#select-all-files").click(o),$("#deselect-all-files").click(c),s(),l(),u(),_(),f()};this.setTorrents=function(e){var n=t;$(n.torrents).unbind("dataChanged.inspector"),$(e).bind("dataChanged.inspector",$.proxy(s,this)),n.torrents=e,clearInterval(n.refreshInterval),n.refreshInterval=setInterval($.proxy(r,this),2e3),r(),s()},b(e)}